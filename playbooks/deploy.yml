---
- import_playbook: variable-check.yml
  vars:
    playbook: deploy.yml

- name: Test Connection
  hosts: "{{ env }}"
  gather_facts: false
  vars:
    dynamic_user: false
    # user that will use is ansible_user specified in inventory (remove this if you want to selected another user)
  roles:
    - { role: connection, tags: [connection, always] }

- name: "Deploying {{ site }} to {{ env }}"
  hosts: "{{ env }}"
  become: true
  pre_tasks:
    - name: Generate unique config ID
      set_fact:
        random_config_id: "{{ 10000 | random }}"
        run_once: yes
    - name: Ensure site is valid
      delegate_to: localhost
      fail:
        msg: "Site `{{ site | default('') }}` is not valid. Available sites to deploy: {{ my_sites.keys() | join(', ') }}"
      when: my_sites[site | default('')] is not defined
    # - name: Ensure repo is valid
    #   delegate_to: localhost
    #   fail:
    #     msg: |
    #       Invalid Git repository.
    #       Ensure that your site's `repo` variable is defined in `group_vars/{{ env }}/my_sites.yml` and uses the SSH format (example: git@github.com:roots/bedrock.git)
    #       More info:
    #       > https://roots.io/trellis/docs/deploys/
    #   when: project.repo is not defined or project.repo is not match("^ssh://.+@.+|.+@.+:.+")
  roles:
    - deploy
